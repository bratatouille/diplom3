{% extends 'base.html' %}
{% block content %}
    <div class="container mx-auto px-4 py-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="mb-12">
            <h1 class="text-4xl font-bold mb-4 text-gray-900 dark:text-white">–ì–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è</h1>
            <p class="text-gray-600 dark:text-gray-400 text-lg">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞, –∏ –º—ã –ø—Ä–µ–¥–ª–æ–∂–∏–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</p>
        </div>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            {% for category in categories %}
            <div class="category-card bg-white dark:bg-[#28303F] shadow-md rounded-xl p-6 cursor-pointer transition-all duration-300 hover:bg-gray-50 dark:hover:bg-[#1E242E] hover:scale-105 border border-gray-200 dark:border-gray-700 {% if category.name == selected_category %}ring-2 ring-blue-500 bg-gray-50 dark:bg-[#1E242E]{% endif %}"
                 data-category="{{ category.name }}">
                <div class="flex flex-col items-center text-center">
                    <!-- –ò–∫–æ–Ω–∫–∞ -->
                    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mb-4 text-2xl">
                        {% if category.name == 'gaming' %}
                            üéÆ
                        {% elif category.name == 'work' %}
                            üíº
                        {% elif category.name == 'office' %}
                            üè¢
                        {% elif category.name == 'design' %}
                            üé®
                        {% elif category.name == 'study' %}
                            üìö
                        {% elif category.name == 'streaming' %}
                            üìπ
                        {% endif %}
                    </div>
                    <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">{{ category.display_name }}</h3>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">{{ category.description }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º–∏ -->
        <div id="computers-section">
            {% include 'core/pc_section.html' %}
        </div>
    </div>

    <!-- Loading –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-[#28303F] rounded-lg p-6 flex items-center space-x-3 shadow-lg">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
            <span class="text-gray-900 dark:text-white">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const categoryCards = document.querySelectorAll('.category-card');
            const computersSection = document.getElementById('computers-section');
            const loading = document.getElementById('loading');

            categoryCards.forEach(card => {
                card.addEventListener('click', function() {
                    const category = this.dataset.category;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                    categoryCards.forEach(c => {
                        c.classList.remove('ring-2', 'ring-blue-500', 'bg-gray-50', 'dark:bg-[#1E242E]');
                        c.classList.add('bg-white', 'dark:bg-[#28303F]');
                    });
                    this.classList.add('ring-2', 'ring-blue-500', 'bg-gray-50', 'dark:bg-[#1E242E]');
                    this.classList.remove('bg-white', 'dark:bg-[#28303F]');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                    loading.classList.remove('hidden');
                    
                    // AJAX –∑–∞–ø—Ä–æ—Å
                    fetch(`${category}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                computersSection.innerHTML = data.html;
                                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
                                computersSection.style.opacity = '0';
                                setTimeout(() => {
                                    computersSection.style.opacity = '1';
                                }, 100);
                            } else {
                                console.error('–û—à–∏–±–∫–∞:', data.error);
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                        })
                        .finally(() => {
                            loading.classList.add('hidden');
                        });
                });
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ç–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä
        function loadPrebuiltConfig(prebuiltId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            {% if not user.is_authenticated %}
                alert('–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                window.location.href = '/users/login/';
                return;
            {% endif %}

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loading.classList.remove('hidden');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            fetch('/pcbuilder/api/load-prebuilt/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    prebuilt_id: prebuiltId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä...');
                    window.location.href = '/pcbuilder/';
                } else {
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
            })
            .finally(() => {
                loading.classList.add('hidden');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

    <style>
        #computers-section {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
{% endblock %}
